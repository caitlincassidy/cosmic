<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8">
<title>Cosmic</title>

<!-- Load style sheets -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.3.1/fullcalendar.min.css">
<link rel="styleheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.3.1/fullcalendar.print.css">

<link href="https://fonts.googleapis.com/css?family=Cairo|Gentium+Basic|Roboto" rel="stylesheet">

 <link rel="stylesheet" href="css/mainLayout.css">

<!-- Use mobile-aware viewport -->
<meta name="viewport" content=
  "width=device-width, initial-scale=1, shrink-to-fit=no">

<!-- Load any supplemental Javascript libraries here -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.3.1/fullcalendar.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

<script src="http://www.eyecon.ro/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>

  <!-- Include Date Range Picker -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.css" />

  <!-- Custom scripts -->
  <script src="js/load-header.js" defer></script>


</head>

<body>

<script>
  ///////////////////
  // DOCUMENT.READY
  //
  $(document).ready(function() {
    displayPreDeterminedTasks();
    setupStickySidebar();

    $("#new_task_due_date").daterangepicker({
      "applyClass": "btn-primary",
      "singleDatePicker": true,
      "startDate": moment().format("MM/DD/YYYY"),
    });
  });

  ///////////////////
  // DOCUMENT METHODS
  //

  // Make new task dropdown display the selected event
  // Source: http://stackoverflow.com/questions/13437446/how-to-display-selected-item-in-bootstrap-button-dropdown-title
  $(document).on('click', ".dropdown-menu li a", function() {
    $("#event-name").text($(this).text());
    $("#event-name").val($(this).text());
    // Keeps the caret down displayed
    $('#event-name').html($(this).text() + ' <span class="caret"></span>');
  });
  // Source: http://stackoverflow.com/questions/13437446/how-to-display-selected-item-in-bootstrap-button-dropdown-title

  // Remove a task when the checkbox next to it is clicked
  $(document).on('click', ":checkbox", function(evt) {
    $(this).parent().parent().parent().fadeOut(
      400,
      function() {
        // Remove dom element
        $(this).remove();
      }
    );
  });

  // Hovering over a task item
  $(document).on('mouseenter', '.task-item', function() {
    // Color light gray
    // TODO(@Becky): pick good accent color
    $(this).css('background-color', " #eac0f7");
    // Make pencil appear
    $(this).find("span").css("visibility", "visible");
  });
  $(document).on('mouseleave', '.task-item', function() {
      // Reset background color
      $(this).css('background-color', "");
      // Make pencil disappear
      $(this).find("span").css("visibility", "hidden");
  });

  // Hovering over a pencil
  // Give affordance for clicking on the pencil
  $(document).on('mouseenter', '.glyphicon-pencil', function() {
    $(this).css("cursor", "pointer");
  })
  $(document).on('mouseleave', '.glyphicon-pencil', function() {
    $(this).css("cursor", "");
  });

  // When pencil button is clicked, make task editable
  $(document).on('click', '.glyphicon-pencil', function() {
    var taskDiv = $(this).parent().parent();
    var task = $(taskDiv).data('task-json');

    // Give this div an ID so it can be removed later
    taskDiv.attr("id", "editing-div");
    // Empty all column divs
    $('#editing-div div').empty();

    // Add text box to edit task text
    var textBox = $('<input>', {
      type: "text",
      id: "new-task-text",
      val: task.text,
    });
    $(textBox).css("width", "100%");
    $(textBox).css("margin-right", "15px");
    textBox.appendTo($(taskDiv).children()[0]);

    // Add due date box to edit with datepicker ability
    // TODO: slightly not centered
    var dueDateBox = $('<input>', {
      type: "text",
      id: "new-task-due",
    });
    $(dueDateBox).css("width", "75%");
    $(dueDateBox).daterangepicker({
      "applyClass": "btn-primary",
      "singleDatePicker": true,
      "startDate": moment(task.due).format("MM/DD/YYYY"),
    });
    dueDateBox.appendTo($(taskDiv).children()[1]);

    // Add a save button to save changes
    var saveButton = $('<button/>',
      {
        type: "button",
        text: "Save",
        class: "btn btn-default",
        id: "save",
      }
    );
    $(saveButton).css("float", "right");
    saveButton.appendTo($(taskDiv).children()[2]);

    // Remove the old task from local storage
    // since when they save a task, it will be
    // added to local storage
    // Assumes there are no tasks with both the same text
    // and the same due date
    var savedTasks = JSON.parse(window.localStorage.getItem("tasks"));
    console.log("len before:" + savedTasks.length);
    var foundElt = savedTasks.find(function(elt) {
      return elt.text == task.text &&
             moment(elt.due).diff(moment(task.due).format("MM/DD/YYYYY"), 'days') == 0;
    });
    var indexToDelete = savedTasks.indexOf(foundElt);
    savedTasks.splice(indexToDelete, 1);
    console.log("len after:" + savedTasks.length);
    window.localStorage.setItem("tasks", JSON.stringify(savedTasks));
  });

  // TODO: If someone clicks on another pencil 
  // while in edit mode on something else it fucks up

  // When someone saves a task edit, update the display
  $(document).on("click", "#save", function(evt) {
    // Create new task
    var task = {
      'text': $("#new-task-text").val(),
      'due': $('#new-task-due').val(),
    }
    var taskDom = makeTaskDom(task);

    // Add to local storage
    var savedTasks = JSON.parse(window.localStorage.getItem("tasks"));
    savedTasks.push(task);
    window.localStorage.setItem("tasks", JSON.stringify(savedTasks));
    
    // Remove div used for editing
    $("#editing-div").remove();

    // Find correct heading the task should be under
    var daysUntilDue = moment(task.due).diff(moment().format("MM/DD/YYYY"), 'days');
    var divId;
    if (daysUntilDue < 0) {
      divId = "#outstanding-contents";
    } else if (daysUntilDue == 0) {
      divId = "#due-today-contents";
    } else {
      divId = "#upcoming-contents";
    }

    // Find all tasks within the heading the task should be
    // in order to place this task in the right order
    var allTasks = $(divId).children();
    if (allTasks.length > 0) {
      // Tasks are ordered earliest to latest
      // Keep going through the tasks until we find one
      // with a later deadline than this task
      var i = 0;
      var taskToCheck = $(allTasks[0]).data("task-json");
      // isLater: boolean, true when new task is still later
      // than the task we're checking
      var isLater = moment(task.due).isAfter(moment(taskToCheck.due).format("MM/DD/YYYY"), 'days');
      while (i < allTasks.length && isLater) {
        i++;
        if (i == allTasks.length) {
          break;
        }
        taskToCheck = $(allTasks[i]).data("task-json");
        isLater = moment(task.due).isAfter(moment(taskToCheck.due).format("MM/DD/YYYY"), 'days');
      }

      // TODO: There's a bug in this I think
      
      // Once while loop finishes, i is the index
      // of task that is later than the new task,
      // so the new task should go right before it
      // (Unless i == allTasks.length, in which case
      //  it should be at the end of the list)
      if (i == allTasks.length) {
        $(allTasks[i-1]).after(taskDom);
      } else {
        $(allTasks[0]).before(taskDom);
      }

    } else {
      // No tasks currently under that heading,
      // so just append it
      $(divId).append(taskDom);
    }

    // TODO: Add animation for the moving between sections?
  });


  ///////////////////
  // HELPER METHODS
  //

  /**
   * Creates a DOM element for a task.
   *
   * @param task a JSON object with 'text' and 'due' fields
   *             representing a task.
   * @returns a DOM object representing that task
   */
  var makeTaskDom = function(task) {
    // Three columns for task text, due date, and pencil icon
    var taskDivString = `
      <div class="row task-item">
        <div class="col-xs-8 text"></div>
        <div class="col-xs-3 due"></div>
        <div class="col-xs-1 pencil"></div>
      </div>
    `;
    var taskDiv = $.parseHTML(taskDivString);

    // Store task information for later
    $(taskDiv).data('task-json', task);

    // Add task text and checkbox to first column
    var textElt = $('<p>', {
      text: task.text,
    });
    var checkbox = $('<input/>', {
      type: "checkbox",
    });
    checkbox.css("margin-right", "10px");
    textElt.prepend(checkbox);
    textElt.appendTo($(taskDiv).children()[0]);

    // Figure out what due date text to display
    // Use mm/dd/yyyy format so it's only comparing days,
    // not hours or minutes
    var daysUntilDue = moment(task.due).diff(moment().format("MM/DD/YYYY"), 'days');
    var dueDateText;
    if (daysUntilDue < 0) {
      // Task is outstanding
      if (daysUntilDue == -1) { // Handle singular case
        dueDateText = "1 day late";
      } else {
        dueDateText = Math.abs(daysUntilDue) + " days late";
      }
    } else if (daysUntilDue == 0) {
      // Task is due today
      dueDateText = "Today";
    } else {
      // Task is upcoming
      if (daysUntilDue == 1) {
        dueDateText = "Tomorrow";
      } else if (daysUntilDue <= 7) {
        dueDateText = "In " + daysUntilDue + " days";
      } else {
        // If it's far enough in the future,
        // so just display the date
        dueDateText = moment(task.due).format("MM/DD/YYYY");
      }
    }

    // Add due date text to second column
    var dueElt = $('<p>', {
      text: dueDateText,
    });
    dueElt.appendTo($(taskDiv).children()[1]);

    // Add (hidden) pencil icon for editing
    pencilElt = $('<span/>', {
      class: "glyphicon glyphicon-pencil",
    });
    pencilElt.appendTo($(taskDiv).children()[2]);

    // Return the entire DOM object
    return taskDiv;
  }

  /**
   * Gets pre-determined tasks from storage and
   * displays them.
   */
  var displayPreDeterminedTasks = function() {
    // Load tasks from storage
    var sampleTasks = JSON.parse(window.localStorage.getItem("tasks"));
    // Sort earliest to latest so they're appended correctly
    sampleTasks.sort(function(a, b) {
      // Should return positive if a is later than b
      return moment(a.due).diff(moment(b.due));
    });

    // Add each task to the document
    sampleTasks.forEach(function(task) {
      var taskDom = makeTaskDom(task);
      // Add it under correct heading
      var daysUntilDue = moment(task.due).diff(moment().format("MM/DD/YYYY"), 'days');
      var divId;
      if (daysUntilDue < 0) {
        divId = "#outstanding-contents";
      } else if (daysUntilDue == 0) {
        divId = "#due-today-contents";
      } else {
        divId = "#upcoming-contents";
      }
      $(divId).append(taskDom);
    });

    // Add a placeholder under any headings that are empty
    /*
    if ($("#outstanding-contents").children().length == 0) {
      $("outstanding-contents").append()
    }
    */
  }

  /**
   * Sets up CSS and JS for keeping the 'add new task'
   * form always displayed, even when scrolling.
   */
	var setupStickySidebar = function() {
    // From http://zurb.com/building-blocks/sticky-sidebar
  	var stickySidebar = $('.sticky');

  	if (stickySidebar.length > 0) { 
  	  var stickyHeight = stickySidebar.height(),
  		  sidebarTop = stickySidebar.offset().top;
  	}

  	// on scroll move the sidebar
  	$(window).scroll(function () {
  	  if (stickySidebar.length > 0) { 
    		var scrollTop = $(window).scrollTop();

    		if (sidebarTop < scrollTop) {
    		  stickySidebar.css('top', scrollTop - sidebarTop);

    		  // stop the sticky sidebar at the footer to avoid overlapping
    		  var sidebarBottom = stickySidebar.offset().top + stickyHeight,
    			  stickyStop = $('.main-content').offset().top + $('.main-content').height();
    		  if (stickyStop < sidebarBottom) {
    			var stopPosition = $('.main-content').height() - stickyHeight;
    			stickySidebar.css('top', stopPosition);
    		  }
    		}
    		else {
    		  stickySidebar.css('top', '0');
    		} 
	    }
	  });

  	$(window).resize(function () {
  	  if (stickySidebar.length > 0) { 
  		stickyHeight = stickySidebar.height();
  	  }
  	});	
	};

</script>


	<div class="container-fluid">
		<div class="row main-header">
      <div class="col-lg-2"></div>
    </div>
  	<div class="row">
  		<div class="col-lg-2" id="menubar">
  		</div>
  		<div class="col-lg-10">
        <div class="page-header">
          <h1>
            <span class="glyphicon glyphicon-list" aria-hidden="true"></span> Tasks
          </h1>
        </div>

        <div class="page-content main-content row">
          <div class="col-lg-8">

            <h3 id="outstanding"> Outstanding </h3>
            <div id="outstanding-contents"></div>

            <h3 id="due-today"> Due today </h3>
            <div id="due-today-contents"></div>

            <h3 id="upcoming"> Upcoming </h3>
            <div id="upcoming-contents"></div>

          </div>
          <div class="col-lg-3 panel sticky" id="sidebar">
				  
            <h2> Add new task </h2>

            <!-- Task text -->
            <div class="form-group">
              <textarea class="form-control" rows="2" placeholder="Task to add"></textarea>
            </div>

            <!-- Date it's due -->
            <div class="form-group">
                <input type='text' class="form-control" placeholder="Due date" id="new_task_due_date"/>
            </div>


            <!-- Event dropdown -->
            <div class="dropdown">
              <button class="btn btn-default dropdown-toggle" type="button" id="event-name" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                Event Name
                <span class="caret"></span>
              </button>

              <!-- TODO: Add more options -->
              <ul class="dropdown-menu" aria-labelledby="event-name">
                <li><a href="#">None</a></li>
                <li role="separator" class="divider"></li>
                <li><a href="#">Quiz 1</a></li>
                <li role="separator" class="divider"></li>
                <li><a href="#">Lecture 1</a></li>
                <li><a href="#">Lecture 2</a></li>
                <li role="separator" class="divider"></li>
                <li><a href="#">Lab 1</a></li>
                <li><a href="#">Lab 2</a></li>
                <li><a href="#">Lab 3</a></li>
                <li><a href="#">Lab 4</a></li>
                <li><a href="#">Lab 5</a></li>
              </ul>
            </div>

            <br />

            <button type="button" class="btn btn-default" style="float: right">Create</button>

		  </div>
          <!-- Margin column -->
          <div class="col-lg-1">
          </div>



        </div> <!-- class=page-content -->


  	</div> <!-- class="row" -->
	</div> <!-- class="container" -->

  <script id="load-menubar-script" src="js/load-menubar.js" link="tasks.html"></script>

</body>

</html>